{% capture headingsWorkspace %}

  {% assign minHeader = 2 %}
  {% assign maxHeader = 6 %}
  {% assign beforeHeading = 1 %}
  {% assign nodes = include.html | split: '<h' %}

  {% capture edited_headings %}{% endcapture %}

  {% for _node in nodes %}
    {% capture node %}{{ _node | strip }}{% endcapture %}

    {% if node == "" %}
      {% continue %}
    {% endif %}

    {% assign nextChar = node | replace: '"', '' | strip | slice: 0, 1 %}
    {% assign headerLevel = nextChar | times: 1 %}

    <!-- If the level is cast to 0, it means it's not a h1-h6 tag, so let's see if we need to fix it -->
    {% if headerLevel == 0 %}
      <!-- Split up the node based on closing angle brackets and get the first one. -->
      {% assign firstChunk = node | split: '>' | first %}

      <!-- If the first chunk does NOT contain a '<', that means we've broken another HTML tag that starts with 'h' -->
      {% unless firstChunk contains '<' %}
        {% capture node %}<h{{ node }}{% endcapture %}
      {% endunless %}

      {% capture edited_headings %}{{ edited_headings }}{{ node }}{% endcapture %}
      {% continue %}
    {% endif %}

    {% capture _closingTag %}</h{{ headerLevel }}>{% endcapture %}
    {% assign _workspace = node | split: _closingTag %}
    {% assign _idWorkspace = _workspace[0] | split: 'id="' %}
    {% assign _idWorkspace = _idWorkspace[1] | split: '"' %}
    {% assign html_id = _idWorkspace[0] %}

    {% capture _hAttrToStrip %}{{ _workspace[0] | split: '>' | first }}>{% endcapture %}
    {% assign header = _workspace[0] | replace: _hAttrToStrip, '' %}

    <!-- Build the anchor to inject for our heading -->
    {% capture anchor %}{% endcapture %}

    {% if html_id and headerLevel >= minHeader and headerLevel <= maxHeader %}
      {% if include.headerAttrs %}
        {% capture _hAttrToStrip %}{{ _hAttrToStrip | split: '>' | first }} {{ include.headerAttrs | replace: '%heading%', header | replace: '%html_id%', html_id }}>{% endcapture %}
      {% endif %}

      {% capture anchor %}href="#{{ html_id }}"{% endcapture %}

      {% if include.anchorClass %}
        {% capture anchor %}{{ anchor }} class="{{ include.anchorClass }}"{% endcapture %}
      {% endif %}

      {% capture anchor %}{{ anchor }} title="{{ header }}"{% endcapture %}

      {% if include.anchorAttrs %}
        {% capture anchor %}{{ anchor }} {{ include.anchorAttrs | replace: '%heading%', header | replace: '%html_id%', html_id }}{% endcapture %}
      {% endif %}

      {% capture anchor %}<a {{ anchor }}>{{ '<svg class="anchor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13.29 9.29l-4 4a1 1 0 0 0 0 1.42 1 1 0 0 0 1.42 0l4-4a1 1 0 0 0-1.42-1.42z" fill="var(--text)"/><path d="M12.28 17.4L11 18.67a4.2 4.2 0 0 1-5.58.4 4 4 0 0 1-.27-5.93l1.42-1.43a1 1 0 0 0 0-1.42 1 1 0 0 0-1.42 0l-1.27 1.28a6.15 6.15 0 0 0-.67 8.07 6.06 6.06 0 0 0 9.07.6l1.42-1.42a1 1 0 0 0-1.42-1.42z" fill="var(--text)"/><path d="M19.66 3.22a6.18 6.18 0 0 0-8.13.68L10.45 5a1.09 1.09 0 0 0-.17 1.61 1 1 0 0 0 1.42 0L13 5.3a4.17 4.17 0 0 1 5.57-.4 4 4 0 0 1 .27 5.95l-1.42 1.43a1 1 0 0 0 0 1.42 1 1 0 0 0 1.42 0l1.42-1.42a6.06 6.06 0 0 0-.6-9.06z" fill="var(--text)"/></svg>
' | replace: '%heading%', header | default: '' }}</a>{% endcapture %}

      <!-- In order to prevent adding extra space after a heading, we'll let the 'anchor' value contain it -->
      {% if beforeHeading %}
        {% capture anchor %}{{ anchor }} {% endcapture %}
      {% else %}
        {% capture anchor %} {{ anchor }}{% endcapture %}
      {% endif %}
    {% endif %}

    {% capture new_heading %}
      <h{{ _hAttrToStrip }}
        {{ include.bodyPrefix }}
        {% if beforeHeading %}
          {{ anchor }}{{ header }}
        {% else %}
          {{ header }}{{ anchor }}
        {% endif %}
        {{ include.bodySuffix }}
      </h{{ headerLevel }}>
    {% endcapture %}

    <!--
    If we have content after the `</hX>` tag, then we'll want to append that here so we don't lost any content.
    -->
    {% assign chunkCount = _workspace | size %}
    {% if chunkCount > 1 %}
      {% capture new_heading %}{{ new_heading }}{{ _workspace | last }}{% endcapture %}
    {% endif %}

    {% capture edited_headings %}{{ edited_headings }}{{ new_heading }}{% endcapture %}
  {% endfor %}
{% endcapture %}{% assign headingsWorkspace = '' %}{{ edited_headings | strip }}
